<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>RabbitMQ 学习笔记 - 基础篇 &mdash; Wu</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://226wyj.github.io/2023/12/19/RabbitMQ-learn-basic/"><link rel="alternate" type="application/atom+xml" title="Wu" href="https://226wyj.github.io/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/favicon.ico"><meta property="og:title" content="RabbitMQ 学习笔记 - 基础篇"><meta name="keywords" content="RabbitMQ, Learn"><meta name="og:keywords" content="RabbitMQ, Learn"><meta name="description" content=" 课程链接：bilibiliP1 - P15"><meta name="og:description" content=" 课程链接：bilibiliP1 - P15"><meta property="og:url" content="https://226wyj.github.io/2023/12/19/RabbitMQ-learn-basic/"><meta property="og:site_name" content="Wu"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-12-19"> <script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://226wyj.github.io/" title="Wu"><span class="octicon octicon-mark-github"></span> Wu</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://226wyj.github.io/" class=" site-header-nav-item" target="" title="Home">Home</a> <a href="https://226wyj.github.io/categories/" class=" site-header-nav-item" target="" title="Categories">Categories</a> <a href="https://226wyj.github.io/wiki/" class=" site-header-nav-item" target="" title="Wiki">Wiki</a> <a href="https://226wyj.github.io/links/" class=" site-header-nav-item" target="" title="Link">Link</a> <a href="https://226wyj.github.io/about/" class=" site-header-nav-item" target="" title="About">About</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="RabbitMQ 学习笔记 -"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">RabbitMQ 学习笔记 - 基础篇</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/12/19 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://226wyj.github.io/categories/#Learn" title="Learn">Learn</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2071 字，约 6 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><blockquote><p>课程链接：<a href="https://www.bilibili.com/video/BV1mN4y1Z7t9/?vd_source=734a4a3d12292363fc3078169ddd7db2">bilibili</a> P1 - P15</p></blockquote><h2 id="同步和异步">同步和异步</h2><h3 id="同步调用">同步调用</h3><p>优势：</p><ul><li>时效性强，等待到结果后才返回</li></ul><p>问题：</p><ul><li>拓展性差：各个服务耦合度高，不易拓展</li><li>性能下降：多个服务需要依次等待上一个服务执行完毕才可以开始运行，性能低</li><li>级联失败：如果中间有某一个服务宕机的话则后续的所有服务都无法继续运行，并且该停机可能会传播到上级服务中，引发全线崩溃</li></ul><h3 id="异步调用">异步调用</h3><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/async.png" alt="" /></p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/async-architecture.png" alt="" /></p><p>异步调用的优势和劣势与同步调用刚好是反过来的</p><p>优势：</p><ul><li>耦合度低，拓展性强</li><li>异步调用，无需等待，性能好</li><li>故障隔离，下游服务故障不影响上游业务</li><li>缓存消息，流量削峰填谷</li></ul><p>劣势：</p><ul><li>不能立即得到调用结果，时效性差</li><li>不确定下游业务是否执行成功</li><li>业务安全依赖于 Broker （消息代理）的可靠性</li></ul><h2 id="mq-技术选型">MQ 技术选型</h2><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/selection.png" alt="" /></p><p>使用场景：</p><ul><li>Kafka：吞吐量很高的情况，比如日志收集</li><li>RabbitMQ：可靠性高，语言不限于 Java，消息延迟低</li><li>RocketMQ：可靠性高，Java 项目</li></ul><h2 id="认识和安装">认识和安装</h2><h3 id="安装">安装</h3><p>在 Mac 环境下通过 Homebrew 安装</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>rabbitmq
</code></pre></div></div><p>启动服务，默认端口是 15672</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew services start rabbitmq
</code></pre></div></div><p>访问管理页面</p><ul><li>url: http://localhost:15672</li><li>username: guest</li><li>password: guest</li></ul><h3 id="基本介绍">基本介绍</h3><p><strong>发送模型</strong></p><p>publisher 生产者发消息给 exchange (交换机)，exchange 负责将消息路由给 queue (队列)，consumer (消费者) 监听队列从而拿到消息</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/basic-concept.png" alt="" /></p><p>交换机是负责路由和转发消息的，它本身没有存储消息的能力</p><p><strong>快速入门</strong></p><p>创建一个新的 queue</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/create-queue.png" alt="" /></p><p>exchange 绑定 queue</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/exchange-bind.png" alt="" /></p><p>Publish message</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/publish-message.png" alt="" /></p><p>Get message</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/get-message.png" alt="" /></p><h2 id="数据隔离">数据隔离</h2><p>添加用户</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/add-user.png" alt="" /></p><p>这里我们添加了一个名为 <code class="language-plaintext highlighter-rouge">hmall</code> 的管理员账户，尽管它可以看到我们在上一步骤中创建的 <code class="language-plaintext highlighter-rouge">hello.queue1</code> 和 <code class="language-plaintext highlighter-rouge">hello.queue2</code> 两个队列，但它却无权访问（get message 会出错）。这是因为上面两个队列是在不同的 virtual host 中创建的，可见 RabbitMQ 通过 Virtual Host 实现了数据隔离。</p><p>创建虚拟主机（Virtual host）</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/add-virtual-host.png" alt="" /></p><p>添加了新的 virtual host 之后我们再次查看 exchanges 页面，会发现这次会多出我们 virtual host 下的 exchange</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/all-exchange.png" alt="" /></p><h2 id="work模式">work模式</h2><p>一个队列上绑定多个消费者的模式叫 work 模式，这样做的目的是为了增加处理能力，避免消息堆积</p><p>默认情况下，<code class="language-plaintext highlighter-rouge">RabbitMQ</code> 会将消息依次轮询投递给绑定在队列上的每一个消费者，但这并没有考虑到不同消费者的消费能力的区别，可能会导致消息堆积</p><p><strong>解决方案：</strong></p><p>修改 <code class="language-plaintext highlighter-rouge">application.yml</code>，设置 <code class="language-plaintext highlighter-rouge">preFetch</code> 值为 1， 确保同一时刻最多投递给消费者 1 条消息，实现能者多劳</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/preFetch.png" alt="" /></p><h2 id="交换机">交换机</h2><p>交换机的作用是：</p><ul><li>接收 publisher 发送的消息</li><li>将消息按照规则路由到与之绑定的队列</li></ul><h3 id="交换机类型">交换机类型</h3><h4 id="fanout广播">Fanout：广播</h4><p>Fanout Exchange 会将接收到的消息广播到每一个跟其绑定的 queue，所以也叫广播模式</p><h4 id="direct定向">Direct：定向</h4><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/direct-exchange.png" alt="" /></p><h4 id="topic话题">Topic：话题</h4><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/topic-exchange.png" alt="" /></p><p>Topic 交换机是最灵活的一种交换机，可以模拟 Direct 和 Fanout，并且可以使用通配符，如果不确定要使用哪种 exchange 则推荐使用 Topic</p><p>Direct 交换机与 Topic 交换机的差异</p><ul><li>Topic 交换机中 routing key 可以是多个单词，以 <code class="language-plaintext highlighter-rouge">.</code> 分割</li><li>Topic 交换机与队列绑定时的 binding key 可以指定通配符</li><li><code class="language-plaintext highlighter-rouge">#</code> 代表 0 个或多个词</li><li><code class="language-plaintext highlighter-rouge">*</code> 代表 1 个词</li></ul><h2 id="springamqp">SpringAMQP</h2><h4 id="amqp--spring-amqp">AMQP &amp; Spring AMQP</h4><p><strong>AMQP</strong>：Advanced Message Queuing Protocol, 用来在应用程序之间传递业务消息的开放标准，该协议与平台语言无关</p><p><strong>Spring AMQP</strong>：基于 AMQP 协议定义的一套 API 规范，提供了模板来发送和接收消息，包含两部分，其中 <code class="language-plaintext highlighter-rouge">spring-amqp</code> 是基础抽象，<code class="language-plaintext highlighter-rouge">spring-rabbit</code> 是底层的默认实现</p><h4 id="快速入门">快速入门</h4><p>项目地址：<a href="https://github.com/226wyj/rabbitmq-learn/tree/main/mq-demo">Github</a></p><p>使用步骤：</p><ul><li>引入 <code class="language-plaintext highlighter-rouge">spring-boot-starter-amqp</code> 依赖</li><li>配置 <code class="language-plaintext highlighter-rouge">rabbitmq</code> 服务端信息</li><li>利用 <code class="language-plaintext highlighter-rouge">RabbitTemplate</code> 发送消息</li><li>利用 <code class="language-plaintext highlighter-rouge">@RabbitListener</code> 注解声明要监听的队列，监听消息</li></ul><p>注意：对于 RabbitMQ，控制台页面的端口是 15672，但正常队列的端口是 5672</p><h4 id="通过-springamqp-配置-rabbitmq">通过 SpringAMQP 配置 RabbitMQ</h4><p>常用类：</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/queue+exchange.png" alt="" /></p><p>基于 <code class="language-plaintext highlighter-rouge">@Configuration</code> 注解和 <code class="language-plaintext highlighter-rouge">@Bean</code> 注解声明和配置 Exchange，以 Fanout 为例：</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/exchange-sample.png" alt="" /></p><p>推荐使用基于 <code class="language-plaintext highlighter-rouge">@RabbitListener</code> 注解的方式来进行配置而不是使用 <code class="language-plaintext highlighter-rouge">@Bean</code> 进行依赖注入，后者在配置 Direct Exchange 的时候对于每个 Bean 每次只能指定一个 key，如果一个 Queue 要是想绑定多个 key 的话就要声明多个 Bean，比较麻烦</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/annotation-based-exchange-config.png" alt="" /></p><h2 id="mq消息转换器">MQ消息转换器</h2><p>Spring 中默认使用 JDK 自带的 ObjectOutputStream 进行序列化，因此如果我们想给 MQ 发送一个 Object，则会被 convert 成一个字节码序列</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/default-converter.png" alt="" /></p><p>解决：使用 JSON 序列化替代默认的 JDK 序列化</p><p><img src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/images/blog/rabbitmq/basic/json-converter.png" alt="" /></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://226wyj.github.io" target="_blank">Wu, Yuejiang</a></li><li>本文链接：<a href="https://226wyj.github.io/2023/12/19/RabbitMQ-learn-basic/" target="_blank">https://226wyj.github.io/2023/12/19/RabbitMQ-learn-basic/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2023/12/19/RabbitMQ-learn-basic/', clientID: '816a74632f6a9e1d895c', clientSecret: '69da216c45ee48df2f0e92506cf044cbc001ef2b', repo: 'blog-comment', owner: '226wyj', admin: ['226wyj'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://226wyj.github.io/assets/search_data.json?v=1704414742', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Wu, Yuejiang">Wu, Yuejiang</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/226wyj/226wyj.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://226wyj.github.io/" title="Home" target="">Home</a></li><li> <a href="https://226wyj.github.io/categories/" title="Categories" target="">Categories</a></li><li> <a href="https://226wyj.github.io/wiki/" title="Wiki" target="">Wiki</a></li><li> <a href="https://226wyj.github.io/links/" title="Link" target="">Link</a></li><li> <a href="https://226wyj.github.io/about/" title="About" target="">About</a></li><li><a href="https://226wyj.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/226wyj/226wyj.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
