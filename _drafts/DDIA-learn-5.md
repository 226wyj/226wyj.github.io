---
layout: post
title: DDIA Learning - 5
categories: [Book, Learn]
description: 数据密集型应用 - 读书笔记
keywords: Architecture, Learn
---

# 第五章 - 数据复制

复制主要指通过互联网络在多台机器上保存想通数据的副本，通过数据复制方案人们通常希望达到以下目的：

* 使数据在地理位置上更接近用户，从而降低访问延迟
* 当部分组件出现故障，系统依然可以继续工作，从而提高可用性
* 扩展至多台机器以同时提供数据访问服务，从而提高吞吐量

## 主节点与从节点

对于每笔数据写入，所有副本都需要随之更新：否则， 某些副本将出现不一致。最常见的解决方案是基于主节点的复制（也称为主动／被动，或主从复制）

1. 指定某一个副本为主副本 （或称为主节点） 。当客户写数据库时，必须将写请求首先发送给主副本，主副本首先将新数据写入本地存储。
2. 其他副本则全部称为从副本（或称为从节点）注 。主副本把新数据写入本地存储后，然后将数据更改作为复制的日志或更改流发送给所有从副本。每个从副本获得更改日志之后将其应用到本地，且严格保持与主副本相同的写入顺序。
3. 客户端从数据库中读数据 ，可以在主副本或者从副本上执行查询。再次强调，只有主副本才可以接受写请求 ：从客户端的角度来看，从副本都是只读的。

### 同步复制与异步复制

**区别**

* 同步复制中，主节点需要等待从节点确认完成了写入，之后才会进行后续处理（如发送 response 向用户报告完成）
* 异步复制中，主节点向从节点发送复制消息之后立即返回，不用等待从节点的完成确认

可以看到，异步复制可能会存在延迟，从而导致某些从节点的数据和主节点的数据不一致。有些情况下，从节点可能落后主节点几分钟甚至更长时间，例如，由于从节点刚从故障中恢复，或者系统已经接近最大设计上限，或者节点之间的网络出现问题

**同步复制优缺点**

* 优点：一旦向用户确认，从节点可以明确保证完成了与主节点的更新同步，数据已经处于最新版本。万一主节点发生故障，总是可以在从节点继续访问最新数据。
* 缺点：如果同步的从节点无法完成确认（例如由于从节点发生崩愤，或者网络故障，或任何其他原因），写入就不能视为成功。主节点会阻塞其后所有的操作，直到同步副本确认完成

**实践**

* 半同步复制：如果数据库启用了同步复制，通常意味着其中某一个从节点是同步的，而其他节点则是异步模式。万一同步的从节点变得不可用或性能下降，则将另一个异步的从节点提升为同步模式。这样可以保证至少有两个节点（即主节点和一个同步从节点）拥有最新的数据副本。这种配置有时也称为半同步
* 全异步复制：此时如果主节点发生失败且不可恢复，则有尚未复制到从节点的写请求都会丢失。这意味着即使向客户端确认了写操作，却无法保证数据的持久化。但全异步配置的优点则是，不管从节点上数据多么滞后，主节点总是可以继续响应写请求，系统的吞吐性能更好

### 配置新的从节点

常见的做法是使用主节点某一时刻数据副本的快照 (snapshot) 进行复制，主要操作步骤为：

1. 在某个时间点对主节点的数据副本产生一个一致性快照，这样避免长时间锁定整个数据库。目前大多数数据库都支持此功能，快照也是系统备份所必需的。而在某些情况下，可能需要第三方工具
2. 将此快照拷贝到新的从节点
3. 从节点连接到主节点并请求快照点之后所发生的数据更改日志。因为在第一步建快照时，快照与系统复制日志的某个确定位置相关联，这个位置信息在不同的系统有不同的称乎
4. 获得日志之后，从节点来应用这些快照点之后所有数据变更，这个过程称之为追赶。接下来，它可以继 处理主节点上新的数据变化。井重复这四个步骤

### 处理节点失效

