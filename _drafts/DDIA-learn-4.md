---
layout: post
title: DDIA Learning - 4
categories: [DDIA, Learn]
description: 《数据密集型应用》读书笔记
keywords: Architecture, Learn
---

# 第四章 - 数据编码与演化

在大多数情况下，更新应用程序功能的同时也要更新其存储的数据：

- 可能需要捕获新的字段或记录类型
- 可能需要以新的方式呈现已有数据

当数据格式或模式发生变化时，经常需要对代码进行相应调整，然而这并不容易：

- 对于服务器端，可能需要执行滚动升级（分阶段发布），即每次将新版本部署到少数几个节点，检查新版本是否正常运行，然后再逐步在所有节点上升级
- 对于客户端，依赖于用户的手动升级，存在一定滞后性

因此，新旧版本的代码以及数据格式可能在系统内共存，这要求我们的系统保持双向兼容性：

- 向后兼容：较新的代码可以读取旧代码编写的数据
- 向前兼容：较旧的代码可以读取新代码编写的数据

## 数据编码格式

程序通常至少使用两种不同的数据表示形式：

- 在内存中，保存在数据结构对象中，这些数据结构针对 CPU 的高效访问和操作进行了优化（通常使用指针）
- 将数据写入文件或通过网络传输时，编码为某种自包含的字节序列（如 JSON）

在这两种表示之间需要进行类型的转化，从内存中的表示到字节序列的转化称为编码（序列化），反之叫解码（反序列化）

### 方案 1 - 某种编程语言的编码库

使用某种编程语言内置的编码方案通常不是个好主意，原因如下：

- 编码与特定的编程语言绑定，使用另一种编程语言访问就非常困难
- 为了在相同的对象类型中恢复数据，解码过程需要能够实例化任意的类，这经常导致一些安全问题
- 在这些编码/解码库中，经常会忽略向前和向后的兼容问题
- 效率问题

### 方案 2 - JSON、XML 与二进制变体

与方案 1 相比，JSON 和 XML 不会囿于某一种编程语言，是可以由不同的编程语言编写和读取的标准化编码。CSV 是另一种流行的与语言无关的格式，尽管功能较弱。

JSON、XML 和 CSV 都是文本格式，可读性高，但除了语法外也有一些问题：

- 数字编码有许多模糊之处
- JSON 和 XML 对 Unicode 字符串有很好的支持，但不支持二进制字符串
- XML 的模式使用较为广泛，但 JSON 一般不会局限于使用模式。某些应用程序可能不得不硬编码适当的编码、解码逻辑来正确解释其信息
- CSV 没有模式，如果应用程序更改添加新的行或列，则必须手动处理

这三种编码方式中，JSON 由于其简单性以及在 Web 浏览器中支持而变成最流行的一种编码方式，但它相比二进制编码占据的空间过大。人们也开发了大量的二进制编码用以支持 JSON（如 BSON、BJSON 等），但没有一个像 JSON 和 XML 那样被广泛采用

### 方案 3 - Thrift 与 Protocol Buffers
